<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- FEATURE 3: Disguised Title for Browser Tabs -->
    <title>Daily Calculator</title>
    
    <!-- FEATURE 3: Disguised PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiRGFpbHkgQ2FsY3VsYXRvciIsInNob3J0X25hbWUiOiJDYWxjdWxhdG9yIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwZjE3MmEiLCJ0aGVtZV9jb2xvciI6IiMwZjE3MmEiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0IiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vY2dnLmNvbS9hcGkvdjEvZ2V0X2ltYWdlP2ltYWdlX3VybD1odHRwczovL2ltYWdlcy51bnNwbGFzaC5jb20vcGhvdG8tMTU4NzE0NTgyOTYwNS00MTA1YTRjMGNmZDA/aXg9dXJsJnF1YWxpdHk9ODUmdz0xOTIiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">
    
    <!-- iOS / PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Calculator">
    <meta name="theme-color" content="#0f172a">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons (Fixed Version) -->
    <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #0f172a;
            /* Midnight Aurora Gradient Background */
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(265, 83%, 15%, 0.3) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 0.3) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
            color: #f8fafc;
            overscroll-behavior: none;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        
        /* Hide Scrollbar */
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        .glass-button {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
        }
        .glass-button:active {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(0.98);
        }

        .pulse-ring {
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(244, 63, 94, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 20px rgba(244, 63, 94, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(244, 63, 94, 0); }
        }
        
        /* Loading Spinner */
        .initial-loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: #e2e8f0;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.1);
            border-left-color: #f43f5e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Animation Utilities */
        .animate-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .slide-in-from-bottom { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <div id="root">
        <div class="initial-loader">
            <div class="spinner"></div>
            <p style="margin-top: 20px; font-size: 14px; opacity: 0.7; font-weight: 500; letter-spacing: 0.5px;">SECURE BOOT...</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, Component } = React;

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); this.setState({ errorInfo }); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex flex-col items-center justify-center h-screen bg-slate-900 p-6 text-center">
                            <div className="w-16 h-16 bg-rose-500/20 rounded-full flex items-center justify-center mb-4">
                                <svg className="w-8 h-8 text-rose-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                            </div>
                            <h2 className="text-xl font-bold text-white mb-2">System Error</h2>
                            <button onClick={() => window.location.reload()} className="mt-4 px-6 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg font-medium transition-colors border border-slate-700">Reboot System</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- FIREBASE CONFIG & MOCK ---
        let auth, db;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'raksha-x-demo';
        const mockStorage = {}; 

        const initializeServices = () => {
            let isRealFirebase = false;
            try {
                if (typeof firebase !== 'undefined' && firebase.apps && typeof __firebase_config !== 'undefined') {
                    const configStr = __firebase_config;
                    if (configStr) {
                        const firebaseConfig = JSON.parse(configStr);
                        if (firebaseConfig && firebaseConfig.apiKey) {
                            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                            auth = firebase.auth();
                            db = firebase.firestore();
                            isRealFirebase = true;
                            auth.onAuthStateChanged(user => { if (!user) auth.signInAnonymously().catch(e => console.error("Auth Failed", e)); });
                        }
                    }
                }
            } catch (e) { console.warn("Firebase Init Error", e); }

            if (!isRealFirebase) {
                auth = {
                    onAuthStateChanged: (cb) => { setTimeout(() => cb({ uid: 'demo-user', displayName: 'Guardian (Demo)' }), 600); return () => {}; },
                    signInWithPopup: () => Promise.resolve(),
                    signInAnonymously: () => Promise.resolve(),
                    signOut: () => { window.location.reload(); },
                    currentUser: { uid: 'demo-user', displayName: 'Guardian (Demo)' }
                };
                const getPathData = (path) => mockStorage[path] || [];
                const setPathData = (path, data) => { mockStorage[path] = data; };
                const createMockDoc = (path) => ({
                    collection: (subPath) => createMockCollection(`${path}/${subPath}`),
                    set: (data) => Promise.resolve(),
                    get: () => Promise.resolve({ exists: false, data: () => ({}) }),
                    delete: () => {
                        const parts = path.split('/');
                        const docId = parts.pop();
                        const colPath = parts.join('/');
                        let list = getPathData(colPath);
                        list = list.filter(d => d.id !== docId);
                        setPathData(colPath, list);
                        return Promise.resolve();
                    },
                    update: (data) => Promise.resolve()
                });
                const createMockCollection = (path) => ({
                    doc: (id) => createMockDoc(`${path}/${id}`),
                    add: (data) => {
                        const newId = 'mock-' + Date.now();
                        const list = getPathData(path);
                        list.push({ id: newId, ...data });
                        setPathData(path, list);
                        return Promise.resolve({ id: newId });
                    },
                    onSnapshot: (cb) => {
                        const list = getPathData(path);
                        cb({ docs: list.map(item => ({ id: item.id, data: () => item })) });
                        const interval = setInterval(() => {
                            const currentList = getPathData(path);
                            if (currentList.length !== list.length) cb({ docs: currentList.map(item => ({ id: item.id, data: () => item })) });
                        }, 1000);
                        return () => clearInterval(interval);
                    }
                });
                db = { collection: (path) => createMockCollection(path) };
            }
        };
        initializeServices();

        // --- COMPONENTS ---

        const Icon = ({ name, className, ...props }) => {
            const [isLoaded, setIsLoaded] = useState(typeof lucide !== 'undefined');
            useEffect(() => {
                if (isLoaded) return;
                const interval = setInterval(() => { if (typeof lucide !== 'undefined') { setIsLoaded(true); clearInterval(interval); } }, 100);
                return () => clearInterval(interval);
            }, [isLoaded]);

            if (!isLoaded || !lucide) return <span className={`inline-block w-5 h-5 bg-white/10 rounded-sm ${className}`} />;

            let iconName = name;
            // Ensure compatibility and map missing icons
            const map = { 'LayoutDashboard': 'Layout', 'ShieldCheck': 'Shield', 'Megaphone': 'Speaker' };
            if (!lucide.icons[iconName] && map[iconName] && lucide.icons[map[iconName]]) iconName = map[iconName];
            
            if (!lucide.icons[iconName]) return <span className={`inline-block w-5 h-5 bg-white/10 rounded-sm ${className}`} />;
            
            try {
                const svgElement = lucide.createElement(lucide.icons[iconName]);
                if (className) svgElement.setAttribute('class', `${svgElement.getAttribute('class') || ''} ${className}`.trim());
                Object.keys(props).forEach(key => svgElement.setAttribute(key.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase(), props[key]));
                return <span dangerouslySetInnerHTML={{ __html: svgElement.outerHTML }} style={{ display: 'inline-flex', alignItems: 'center', lineHeight: 0 }} />;
            } catch (err) { return <span className={`inline-block w-5 h-5 bg-rose-500/20 rounded-sm ${className}`} />; }
        };

        const Logo = () => (
            <div className="flex items-center gap-3">
                <div className="relative flex items-center justify-center w-9 h-9 rounded-xl bg-gradient-to-br from-rose-500 to-violet-600 shadow-lg shadow-rose-500/20 ring-1 ring-white/10">
                    <Icon name="Shield" className="text-white w-5 h-5 relative z-10" />
                </div>
                <span className="text-xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-white via-rose-100 to-rose-200">
                    Raksha<span className="text-rose-500">X</span>
                </span>
            </div>
        );

        // --- AUDIO ENGINE ---
        class SirenManager {
            constructor() { this.audioCtx = null; this.oscillator = null; this.gainNode = null; this.lfo = null; this.lfoGain = null; }
            isActive() { return !!this.oscillator; }
            start() {
                try {
                    if (!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    if (this.audioCtx.state === 'suspended') this.audioCtx.resume();
                    this.oscillator = this.audioCtx.createOscillator();
                    this.oscillator.type = 'sawtooth';
                    this.oscillator.frequency.value = 800;
                    this.gainNode = this.audioCtx.createGain();
                    this.gainNode.gain.value = 0.5;
                    this.lfo = this.audioCtx.createOscillator();
                    this.lfo.type = 'sine';
                    this.lfo.frequency.value = 2; 
                    this.lfoGain = this.audioCtx.createGain();
                    this.lfoGain.gain.value = 400;
                    this.lfo.connect(this.lfoGain);
                    this.lfoGain.connect(this.oscillator.frequency);
                    this.oscillator.connect(this.gainNode);
                    this.gainNode.connect(this.audioCtx.destination);
                    this.oscillator.start();
                    this.lfo.start();
                } catch (e) { console.error("Audio Context Error:", e); }
            }
            stop() {
                try {
                    if (this.oscillator) { this.oscillator.stop(); this.oscillator.disconnect(); this.oscillator = null; }
                    if (this.lfo) { this.lfo.stop(); this.lfo.disconnect(); this.lfo = null; }
                    if (this.gainNode) { this.gainNode.disconnect(); this.gainNode = null; }
                } catch (e) { console.error("Error stopping audio:", e); }
            }
        }

        // --- VIEWS ---

        const ContactsView = ({ user, onBack }) => {
            const [contacts, setContacts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isAdding, setIsAdding] = useState(false);
            const [newContact, setNewContact] = useState({ name: '', phone: '', relation: '' });
            const [error, setError] = useState('');

            useEffect(() => {
                if (!user) return;
                const contactsRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('contacts');
                const unsubscribe = contactsRef.onSnapshot((snapshot) => {
                    setContacts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                }, () => setLoading(false));
                return () => unsubscribe();
            }, [user]);

            const handleAddContact = async (e) => {
                e.preventDefault();
                if (!newContact.name || !newContact.phone) return setError('Name and Phone required');
                try {
                    await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('contacts').add({
                        name: newContact.name, phone: newContact.phone, relation: newContact.relation || 'Friend', createdAt: new Date().toISOString()
                    });
                    setNewContact({ name: '', phone: '', relation: '' }); setIsAdding(false);
                } catch (err) { setError('Failed to save.'); }
            };

            const handleDelete = async (id) => {
                if (!confirm("Remove contact?")) return;
                try { await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('contacts').doc(id).delete(); } catch(e){}
            };

            return (
                <div className="h-full flex flex-col px-5 pb-24 overflow-y-auto animate-in">
                    <div className="flex items-center gap-4 py-6 sticky top-0 bg-[#0f172a]/90 backdrop-blur-md z-10 border-b border-white/5">
                        <button onClick={onBack} className="glass-button p-2 rounded-full"><Icon name="ArrowLeft" className="w-5 h-5 text-white" /></button>
                        <h2 className="text-xl font-bold text-white">Guardian Contacts</h2>
                        <button onClick={() => setIsAdding(!isAdding)} className={`ml-auto p-2 rounded-full glass-button ${isAdding ? 'bg-rose-500/20 text-rose-400' : 'text-emerald-400'}`}>
                            <Icon name={isAdding ? "X" : "Plus"} className="w-5 h-5" />
                        </button>
                    </div>

                    {isAdding && (
                        <div className="mb-6 glass-panel p-5 rounded-2xl animate-in">
                            <h3 className="text-sm font-bold text-slate-300 mb-4 uppercase tracking-wider">New Contact</h3>
                            <form onSubmit={handleAddContact} className="space-y-3">
                                <input type="text" placeholder="Name" className="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-rose-500 transition-colors" value={newContact.name} onChange={e => setNewContact({...newContact, name: e.target.value})} />
                                <input type="tel" placeholder="Phone Number" className="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-rose-500 transition-colors" value={newContact.phone} onChange={e => setNewContact({...newContact, phone: e.target.value})} />
                                <input type="text" placeholder="Relationship (e.g. Mom)" className="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-rose-500 transition-colors" value={newContact.relation} onChange={e => setNewContact({...newContact, relation: e.target.value})} />
                                {error && <p className="text-xs text-rose-400 font-medium">{error}</p>}
                                <button type="submit" className="w-full bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-bold py-3 rounded-xl text-sm shadow-lg shadow-emerald-500/20 active:scale-95 transition-transform">Save Contact</button>
                            </form>
                        </div>
                    )}

                    {loading ? <div className="flex justify-center py-10"><div className="spinner w-6 h-6 border-2"></div></div> : contacts.length === 0 ? (
                        <div className="text-center py-20 px-4 opacity-60 flex flex-col items-center">
                            <div className="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center mb-4"><Icon name="Users" className="w-8 h-8 text-slate-500" /></div>
                            <p className="text-slate-300 font-medium">No contacts yet.</p>
                            <p className="text-xs text-slate-500 mt-1">Add trusted people to notify in emergencies.</p>
                        </div>
                    ) : (
                        <div className="space-y-3">
                            {contacts.map(contact => (
                                <div key={contact.id} className="glass-panel p-4 rounded-2xl flex items-center justify-between group hover:bg-white/5 transition-colors">
                                    <div className="flex items-center gap-4">
                                        <div className="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold shadow-lg shadow-indigo-500/20">
                                            {(contact.name || '?').charAt(0).toUpperCase()}
                                        </div>
                                        <div>
                                            <p className="text-white font-bold text-sm">{contact.name}</p>
                                            <div className="flex items-center gap-2 text-xs text-slate-400 mt-0.5">
                                                <span className="bg-white/10 px-1.5 py-0.5 rounded text-slate-300">{contact.relation}</span>
                                                <span>{contact.phone}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <button onClick={() => handleDelete(contact.id)} className="p-2 text-slate-500 hover:text-rose-400 transition-colors"><Icon name="Trash2" className="w-4 h-4" /></button>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const HomeView = ({ user, setView }) => {
            const [isSOSActive, setIsSOSActive] = useState(false);
            const [isSirenActive, setIsSirenActive] = useState(false);
            const [countdown, setCountdown] = useState(5);
            const [guardianCount, setGuardianCount] = useState(0);
            const timerRef = useRef(null);
            const sirenRef = useRef(null);

            useEffect(() => { sirenRef.current = new SirenManager(); return () => { if (sirenRef.current) sirenRef.current.stop(); }; }, []);

            const toggleSiren = () => {
                if (!sirenRef.current) return;
                if (isSirenActive) { sirenRef.current.stop(); setIsSirenActive(false); } 
                else { sirenRef.current.start(); setIsSirenActive(true); }
            };

            useEffect(() => {
                if (!user) return;
                const contactsRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('contacts');
                const unsubscribe = contactsRef.onSnapshot(snap => setGuardianCount(snap.docs.length), () => setGuardianCount(0));
                return () => unsubscribe();
            }, [user]);

            useEffect(() => { return () => { if (timerRef.current) clearInterval(timerRef.current); }; }, []);

            const handleSOSClick = () => {
                if (isSOSActive) { setIsSOSActive(false); clearInterval(timerRef.current); setCountdown(5); } 
                else {
                    setIsSOSActive(true);
                    timerRef.current = setInterval(() => {
                        setCountdown(prev => {
                            if (prev <= 1) {
                                clearInterval(timerRef.current);
                                alert(`SOS ALERT SENT!\nNotifying ${guardianCount} Guardian(s) with your live location.`);
                                setIsSOSActive(false);
                                return 5;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                }
            };

            return (
                <div className="flex flex-col h-full px-6 pb-28 overflow-y-auto animate-in">
                    <div className="mt-6 mb-8 flex justify-between items-start">
                        <div>
                            <h1 className="text-2xl font-bold text-white mb-1">Hello, {user?.displayName ? user.displayName.split(' ')[0] : 'Guardian'}</h1>
                            <div className="flex items-center gap-2 bg-emerald-500/10 px-3 py-1.5 rounded-full w-fit border border-emerald-500/20 backdrop-blur-sm">
                                <span className="w-2 h-2 bg-emerald-400 rounded-full animate-pulse shadow-[0_0_8px_rgba(52,211,153,0.5)]"></span>
                                <span className="text-xs font-bold tracking-wide text-emerald-300">SYSTEM ACTIVE</span>
                            </div>
                        </div>
                        <div className="p-3 glass-panel rounded-full text-emerald-400 shadow-lg shadow-emerald-500/10">
                            <Icon name="ShieldCheck" className="w-6 h-6" />
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col items-center justify-center min-h-[320px] relative">
                        {/* Decorative circles behind SOS */}
                        <div className="absolute inset-0 flex items-center justify-center opacity-30 pointer-events-none">
                            <div className={`w-64 h-64 rounded-full border border-rose-500/20 ${isSOSActive ? 'animate-ping' : ''}`}></div>
                            <div className={`absolute w-80 h-80 rounded-full border border-rose-500/10 ${isSOSActive ? 'animate-ping' : ''}`} style={{animationDelay: '0.2s'}}></div>
                        </div>

                        <button 
                            onClick={handleSOSClick}
                            className={`relative w-52 h-52 rounded-full flex items-center justify-center transition-all duration-500 z-10 
                                ${isSOSActive 
                                    ? 'bg-white text-rose-600 scale-110 shadow-[0_0_60px_rgba(255,255,255,0.4)]' 
                                    : 'bg-gradient-to-b from-rose-500 to-rose-700 shadow-[0_0_50px_rgba(244,63,94,0.4)] hover:scale-105 active:scale-95'
                                }`}
                        >
                            {isSOSActive && <div className="absolute inset-0 rounded-full pulse-ring bg-rose-500/30"></div>}
                            <div className="flex flex-col items-center z-10">
                                {isSOSActive ? (
                                    <span className="text-7xl font-black font-mono tracking-tighter">{countdown}</span>
                                ) : (
                                    <>
                                        <Icon name="Bell" className="w-20 h-20 text-white mb-2 drop-shadow-md" strokeWidth={1.5} />
                                        <span className="text-2xl font-black text-white tracking-[0.2em] drop-shadow-md">SOS</span>
                                    </>
                                )}
                            </div>
                        </button>
                        <p className="mt-8 text-slate-300 text-sm font-medium text-center max-w-[220px] glass-panel py-2 px-4 rounded-full">
                            {isSOSActive ? "Tap to CANCEL" : `Tap to alert ${guardianCount > 0 ? guardianCount : 'Emergency'} Contacts`}
                        </p>
                    </div>

                    <div className="grid grid-cols-2 gap-3 mt-4 slide-in-from-bottom">
                        <button onClick={() => setView('contacts')} className="glass-panel p-4 rounded-2xl flex flex-col items-center justify-center gap-2 active:scale-95 transition-transform relative overflow-hidden group bg-gradient-to-br from-white/5 to-transparent">
                            <div className="absolute inset-0 bg-purple-500/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div className="p-3 bg-purple-500/20 rounded-full text-purple-300 ring-1 ring-purple-500/30">
                                <Icon name="Users" className="w-6 h-6" />
                            </div>
                            <span className="text-sm font-semibold text-slate-200">Guardians</span>
                        </button>
                        
                        <button onClick={() => setView('helplines')} className="glass-panel p-4 rounded-2xl flex flex-col items-center justify-center gap-2 active:scale-95 transition-transform relative overflow-hidden group bg-gradient-to-br from-white/5 to-transparent">
                            <div className="absolute inset-0 bg-rose-500/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div className="p-3 bg-rose-500/20 rounded-full text-rose-300 ring-1 ring-rose-500/30">
                                <Icon name="Phone" className="w-6 h-6" />
                            </div>
                            <span className="text-sm font-semibold text-slate-200">Helplines</span>
                        </button>

                        <button onClick={() => setView('protocol')} className="glass-panel p-4 rounded-2xl flex flex-col items-center justify-center gap-2 active:scale-95 transition-transform relative overflow-hidden group bg-gradient-to-br from-white/5 to-transparent">
                            <div className="absolute inset-0 bg-amber-500/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div className="p-3 bg-amber-500/20 rounded-full text-amber-300 ring-1 ring-amber-500/30">
                                <Icon name="BookOpen" className="w-6 h-6" />
                            </div>
                            <span className="text-sm font-semibold text-slate-200">Protocols</span>
                        </button>
                        
                        <button onClick={() => setView('map')} className="glass-panel p-4 rounded-2xl flex flex-col items-center justify-center gap-2 active:scale-95 transition-transform relative overflow-hidden group bg-gradient-to-br from-white/5 to-transparent">
                            <div className="absolute inset-0 bg-emerald-500/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <div className="p-3 bg-emerald-500/20 rounded-full text-emerald-300 ring-1 ring-emerald-500/30">
                                <Icon name="MapPin" className="w-6 h-6" />
                            </div>
                            <span className="text-sm font-semibold text-slate-200">Safe Map</span>
                        </button>

                        <button 
                            onClick={toggleSiren}
                            className={`glass-panel p-4 rounded-2xl flex flex-col items-center justify-center gap-2 active:scale-95 transition-all col-span-2 relative overflow-hidden ${isSirenActive ? 'bg-orange-500/20 ring-2 ring-orange-500/50 animate-pulse' : 'bg-gradient-to-br from-white/5 to-transparent'}`}
                        >
                            {isSirenActive && <div className="absolute inset-0 bg-orange-500/20 animate-ping"></div>}
                            <div className={`p-3 rounded-full relative z-10 ${isSirenActive ? 'bg-orange-500 text-white' : 'bg-orange-500/20 text-orange-400 ring-1 ring-orange-500/30'}`}>
                                <Icon name="Megaphone" className="w-6 h-6" />
                            </div>
                            <span className={`text-sm font-bold relative z-10 ${isSirenActive ? 'text-white' : 'text-slate-200'}`}>
                                {isSirenActive ? 'STOP SIREN' : 'Loud Siren Alarm'}
                            </span>
                        </button>
                    </div>

                    <div className="mt-3 slide-in-from-bottom" style={{animationDelay: '0.1s'}}>
                         <button onClick={() => setView('rights')} className="w-full glass-panel p-4 rounded-2xl flex items-center justify-between active:scale-95 transition-transform border-l-4 border-l-indigo-500 bg-gradient-to-r from-indigo-900/20 to-transparent">
                            <div className="flex items-center gap-4">
                                <div className="p-2.5 bg-indigo-500/20 rounded-full text-indigo-300 ring-1 ring-indigo-500/30">
                                    <Icon name="Scale" className="w-5 h-5" />
                                </div>
                                <div className="text-left">
                                    <span className="block text-sm font-bold text-white">Know Your Rights</span>
                                    <span className="text-xs text-slate-400">Legal awareness story cards</span>
                                </div>
                            </div>
                            <Icon name="ChevronRight" className="w-5 h-5 text-slate-600" />
                        </button>
                    </div>
                </div>
            );
        };

        const MapView = ({ onBack }) => (
            <div className="h-full flex flex-col bg-[#0f172a] animate-in">
                <div className="p-6 flex items-center gap-4 glass-panel z-10 relative">
                    <button onClick={onBack} className="glass-button p-2 rounded-full"><Icon name="ArrowLeft" className="w-5 h-5 text-white" /></button>
                    <h2 className="text-lg font-bold text-white">Live Tracking</h2>
                </div>
                <div className="flex-1 flex items-center justify-center relative overflow-hidden bg-slate-900">
                    <div className="absolute inset-0 opacity-20" style={{backgroundImage: 'radial-gradient(circle at 50% 50%, #334155 1px, transparent 1px)', backgroundSize: '30px 30px'}}></div>
                    <div className="absolute inset-0 bg-gradient-to-t from-[#0f172a] to-transparent pointer-events-none"></div>
                    <div className="text-center p-8 z-10">
                        <div className="w-20 h-20 rounded-full bg-slate-800 flex items-center justify-center mx-auto mb-4 border border-slate-700 shadow-xl">
                            <Icon name="Map" className="w-10 h-10 text-slate-500" />
                        </div>
                        <p className="text-slate-300 font-bold text-lg">Map Module Unavailable</p>
                        <p className="text-sm text-slate-500 mt-2">API Key Required for G-Maps Integration</p>
                    </div>
                </div>
            </div>
        );

        const HelplinesView = ({ onBack }) => {
            const helplines = [
                { name: "Emergency", number: "112", icon: "AlertTriangle", color: "text-rose-400", bg: "bg-rose-500/10", border: "border-rose-500/50" },
                { name: "Police", number: "100", icon: "Shield", color: "text-blue-400", bg: "bg-blue-500/10", border: "border-blue-500/50" },
                { name: "Ambulance", number: "102", icon: "Activity", color: "text-emerald-400", bg: "bg-emerald-500/10", border: "border-emerald-500/50" },
                { name: "Women's Helpline", number: "1091", icon: "Heart", color: "text-pink-400", bg: "bg-pink-500/10", border: "border-pink-500/50" },
                { name: "Fire Brigade", number: "101", icon: "Flame", color: "text-orange-400", bg: "bg-orange-500/10", border: "border-orange-500/50" },
                { name: "Cyber Crime", number: "1930", icon: "Lock", color: "text-cyan-400", bg: "bg-cyan-500/10", border: "border-cyan-500/50" },
                { name: "Child Helpline", number: "1098", icon: "Smile", color: "text-yellow-400", bg: "bg-yellow-500/10", border: "border-yellow-500/50" },
                { name: "Senior Citizen", number: "14567", icon: "User", color: "text-indigo-400", bg: "bg-indigo-500/10", border: "border-indigo-500/50" },
            ];

            return (
                <div className="h-full flex flex-col px-5 pb-24 overflow-y-auto animate-in">
                    <div className="flex items-center gap-4 py-6 sticky top-0 bg-[#0f172a]/90 backdrop-blur-md z-10 border-b border-white/5">
                        <button onClick={onBack} className="glass-button p-2 rounded-full"><Icon name="ArrowLeft" className="w-5 h-5 text-white" /></button>
                        <h2 className="text-xl font-bold text-white">Emergency Numbers</h2>
                    </div>
                    <div className="grid gap-3">
                        {helplines.map((item, idx) => (
                            <div key={idx} className={`glass-panel p-4 rounded-xl flex items-center justify-between group hover:bg-white/5 transition-colors border-l-4 ${item.border}`}>
                                <div className="flex items-center gap-4">
                                    <div className={`w-12 h-12 rounded-full flex items-center justify-center ${item.bg} ${item.color} ring-1 ring-white/10`}>
                                        <Icon name={item.icon} className="w-6 h-6" />
                                    </div>
                                    <div>
                                        <h3 className="text-slate-200 font-semibold text-sm">{item.name}</h3>
                                        <p className="text-2xl font-bold text-white tracking-wider font-mono">{item.number}</p>
                                    </div>
                                </div>
                                <a href={`tel:${item.number}`} className={`p-3 rounded-full ${item.bg} ${item.color} active:scale-95 transition-transform`}><Icon name="Phone" className="w-5 h-5" /></a>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const RightsView = ({ onBack }) => {
            const [selectedRight, setSelectedRight] = useState(null);
            const rights = [
                { id: 1, title: "Right to Zero FIR", icon: "FileText", desc: "You can file a First Information Report (FIR) at any police station irrespective of the location of the incident. The police cannot refuse to register it." },
                { id: 2, title: "No Arrest After Sunset", icon: "Moon", desc: "Under Section 46 of CrPC, women cannot be arrested after sunset and before sunrise, except in exceptional circumstances with a magistrate's order." },
                { id: 3, title: "Right to Privacy", icon: "EyeOff", desc: "Under Section 228A of IPC, the identity of a rape victim must be kept confidential. Police and media cannot disclose your name or photo." },
                { id: 4, title: "Right to Free Legal Aid", icon: "Scale", desc: "Female victims of violence (rape, domestic abuse, etc.) have the right to get free legal assistance from the Legal Services Authority." },
                { id: 5, title: "Virtual Complaints", icon: "Mail", desc: "You have the right to file a complaint via email or registered post if you cannot physically visit a police station." },
                { id: 6, title: "No Harassment at Work", icon: "Briefcase", desc: "The POSH Act 2013 mandates that every workplace with 10+ employees must have an Internal Complaints Committee (ICC) for sexual harassment." },
            ];

            return (
                <div className="h-full flex flex-col px-5 pb-24 overflow-y-auto animate-in">
                    <div className="flex items-center gap-4 py-6 sticky top-0 bg-[#0f172a]/90 backdrop-blur-md z-10 border-b border-white/5">
                        <button onClick={onBack} className="glass-button p-2 rounded-full"><Icon name="ArrowLeft" className="w-5 h-5 text-white" /></button>
                        <h2 className="text-xl font-bold text-white">Women's Rights</h2>
                    </div>
                    <div className="space-y-3">
                        {rights.map(right => (
                            <div key={right.id} className={`glass-panel rounded-2xl overflow-hidden transition-all duration-300 ${selectedRight === right.id ? 'bg-white/5 ring-1 ring-indigo-500/50' : ''}`}>
                                <button onClick={() => setSelectedRight(selectedRight === right.id ? null : right.id)} className="w-full p-4 flex items-center justify-between text-left hover:bg-white/5 transition-colors">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-full bg-indigo-500/20 text-indigo-300 flex items-center justify-center ring-1 ring-indigo-500/30">
                                            <Icon name={right.icon} className="w-5 h-5" />
                                        </div>
                                        <span className="font-bold text-slate-200 text-sm">{right.title}</span>
                                    </div>
                                    <Icon name={selectedRight === right.id ? "ChevronUp" : "ChevronDown"} className="w-5 h-5 text-slate-500" />
                                </button>
                                {selectedRight === right.id && (
                                    <div className="px-4 pb-4 pt-0 animate-in">
                                        <div className="h-px w-full bg-white/10 mb-3"></div>
                                        <p className="text-sm text-slate-300 leading-relaxed">{right.desc}</p>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ProtocolView = ({ onBack }) => {
            const [selectedId, setSelectedId] = useState(null);
            const protocols = [
                { id: 'general', title: 'General Safety', icon: 'Shield', color: 'text-emerald-400', bg: 'bg-emerald-500/20' },
                { id: 'harassment', title: 'Harassment', icon: 'AlertTriangle', color: 'text-orange-400', bg: 'bg-orange-500/20' },
                { id: 'medical', title: 'Medical Emergency', icon: 'Heart', color: 'text-rose-400', bg: 'bg-rose-500/20' }
            ];

            return (
                <div className="h-full flex flex-col px-5 pb-24 overflow-y-auto animate-in">
                     <div className="flex items-center gap-4 py-6 sticky top-0 bg-[#0f172a]/90 backdrop-blur-md z-10 border-b border-white/5">
                        <button onClick={onBack} className="glass-button p-2 rounded-full"><Icon name="ArrowLeft" className="w-5 h-5 text-white" /></button>
                        <h2 className="text-xl font-bold text-white">Safety Protocols</h2>
                    </div>
                    <div className="grid gap-3">
                        {protocols.map(p => (
                            <div key={p.id} className="glass-panel p-4 rounded-2xl flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center ${p.bg} ${p.color} ring-1 ring-white/10`}>
                                        <Icon name={p.icon} className="w-5 h-5" />
                                    </div>
                                    <span className="font-semibold text-slate-200">{p.title}</span>
                                </div>
                                <Icon name="ChevronRight" className="w-5 h-5 text-slate-500" />
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const LegalView = ({ onBack }) => (
            <div className="h-full p-5 overflow-y-auto animate-in">
                <button onClick={onBack} className="mb-6 glass-button p-2 rounded-full"><Icon name="ArrowLeft" className="w-5 h-5 text-white" /></button>
                <h1 className="text-2xl font-bold text-white mb-4">Legal & Privacy</h1>
                <div className="text-slate-400 space-y-4 text-sm glass-panel p-6 rounded-2xl">
                    <p><strong className="text-white">Disclaimer:</strong> This is a demonstration build of Raksha X. Emergency services features (SOS, Calling) are simulated.</p>
                    <p>In a real emergency, always call your local emergency number (e.g., 911, 100, 112) directly from your phone's dialer.</p>
                    <div className="h-px bg-white/10 my-4"></div>
                    <p className="text-xs text-slate-500">Version 1.2.0 (Aurora Build)</p>
                </div>
            </div>
        );

        const QuickExitButton = () => (
            <button onClick={() => window.location.replace("https://www.google.com")} className="absolute bottom-6 right-6 z-50 bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 px-5 rounded-full shadow-lg shadow-rose-900/50 flex items-center gap-2 transition-transform active:scale-95 border border-rose-400/30 backdrop-blur-md">
                <Icon name="LogOut" className="w-5 h-5" /><span className="text-sm tracking-wide uppercase">Exit</span>
            </button>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('home');
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [isAuthReady, setIsAuthReady] = useState(false);

            useEffect(() => {
                let mounted = true;
                const unsubscribe = auth.onAuthStateChanged((u) => { if (mounted) { if (u) setUser(u); setIsAuthReady(true); } });
                const safetyTimeout = setTimeout(() => { if (mounted && !isAuthReady) { setUser({ uid: 'guest-fallback', displayName: 'Guest' }); setIsAuthReady(true); } }, 2500);
                return () => { mounted = false; unsubscribe(); clearTimeout(safetyTimeout); };
            }, [isAuthReady]);

            const signOut = () => auth.signOut();
            const installApp = () => alert("To install: Tap Share -> Add to Home Screen");

            if (!isAuthReady) return <div className="flex items-center justify-center h-screen bg-[#0f172a]"><div className="spinner"></div></div>;

            return (
                <div className="h-screen w-full flex flex-col relative overflow-hidden bg-[#0f172a]">
                    <nav className="absolute top-0 left-0 right-0 h-20 px-6 flex items-center justify-between z-50">
                        <Logo />
                        <div className="relative">
                            <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className="glass-button p-2.5 rounded-full text-white hover:bg-white/10"><Icon name={mobileMenuOpen ? "X" : "Menu"} className="w-6 h-6" /></button>
                            {mobileMenuOpen && (
                                <div className="absolute right-0 top-16 w-64 glass-panel rounded-2xl p-2 flex flex-col gap-1 shadow-2xl animate-in z-50">
                                    <div className="px-4 py-4 border-b border-white/5 mb-1">
                                        <p className="text-xs text-slate-400 uppercase tracking-wider font-bold">Signed in as</p>
                                        <p className="text-sm text-white font-medium truncate">{user?.displayName || 'Anonymous User'}</p>
                                    </div>
                                    {[
                                        { id: 'home', label: 'Dashboard', icon: 'Home' }, // Changed to Home icon
                                        { id: 'contacts', label: 'Guardian Contacts', icon: 'Users' },
                                        { id: 'helplines', label: 'Emergency Numbers', icon: 'Phone' },
                                        { id: 'rights', label: 'Women Rights', icon: 'Scale' },
                                        { id: 'map', label: 'Safe Map', icon: 'MapPin' },
                                        { id: 'protocol', label: 'Safety Protocols', icon: 'BookOpen' },
                                        { id: 'legal', label: 'Legal Info', icon: 'FileText' }
                                    ].map(item => (
                                        <button key={item.id} onClick={() => { setView(item.id); setMobileMenuOpen(false); }} className={`flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-colors ${view === item.id ? 'bg-rose-500 text-white shadow-lg shadow-rose-500/20' : 'text-slate-300 hover:bg-white/5'}`}>
                                            <Icon name={item.icon} className="w-4 h-4" />{item.label}
                                        </button>
                                    ))}
                                    <div className="h-px bg-white/5 my-1"></div>
                                    <button onClick={installApp} className="text-left px-5 py-4 rounded-2xl text-sm font-bold text-emerald-400 hover:bg-emerald-500/10 transition-all flex items-center gap-2"><Icon name="Download" className="w-4 h-4" /> Install App</button>
                                    <button onClick={() => { signOut(); setMobileMenuOpen(false); }} className="text-left px-5 py-4 rounded-2xl text-sm font-bold text-rose-400 hover:bg-rose-500/10 transition-all flex items-center gap-2"><Icon name="LogOut" className="w-4 h-4" /> Sign Out</button>
                                </div>
                            )}
                        </div>
                    </nav>
                    <main className="h-full w-full pt-20">
                        {view === 'home' && <HomeView user={user} setView={setView} />}
                        {view === 'contacts' && <ContactsView user={user} onBack={() => setView('home')} />}
                        {view === 'helplines' && <HelplinesView onBack={() => setView('home')} />}
                        {view === 'rights' && <RightsView onBack={() => setView('home')} />}
                        {view === 'map' && <MapView onBack={() => setView('home')} />}
                        {view === 'protocol' && <ProtocolView onBack={() => setView('home')} />}
                        {view === 'legal' && <LegalView onBack={() => setView('home')} />}
                    </main>
                    <QuickExitButton />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
