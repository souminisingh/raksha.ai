<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- FEATURE 3: Disguised Title for Browser Tabs -->
    <title>Daily Calculator</title>
    
    <!-- FEATURE 3: Disguised PWA Manifest (Calculator Icon & Name) -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiRGFpbHkgQ2FsY3VsYXRvciIsInNob3J0X25hbWUiOiJDYWxjdWxhdG9yIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxZTI5M2IiLCJ0aGVtZV9jb2xvciI6IiMzMzQxNTUiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0IiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzIzNDQvMjM0NDEzMi5wbmciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">
    
    <!-- iOS / PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Calculator">
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- FIX: Pinned Lucide version for stability -->
    <script src="https://unpkg.com/lucide@0.263.1"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #020617; /* Slate 950 */
            color: #f8fafc;
            overscroll-behavior: none;
        }
        /* Hide Scrollbar */
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .neon-shadow {
            box-shadow: 0 0 20px rgba(244, 63, 94, 0.3);
        }
        .pulse-ring {
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(244, 63, 94, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(244, 63, 94, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(244, 63, 94, 0); }
        }
        
        /* FIX: PWA Scroll & Zoom Stability */
        html, body {
            overscroll-behavior-y: none;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        #root {
            touch-action: pan-x pan-y;
        }
        input, textarea, select {
            font-size: 16px !important;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ROBUST FIREBASE INITIALIZATION ---
        // Checks environment config. If missing/invalid, creates a mock Auth object 
        // to prevent the app from crashing (Blank Screen Fix).
        
        let auth, db;
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        try {
            if (firebaseConfig && firebaseConfig.apiKey && !firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
            } else if (!firebase.apps.length) {
                // If we already have an initialized app but no config passed this time
                if (firebase.apps.length > 0) {
                     auth = firebase.auth();
                     db = firebase.firestore();
                } else {
                    throw new Error("No valid Firebase config available");
                }
            } else {
                 auth = firebase.auth();
                 db = firebase.firestore();
            }
        } catch (e) {
            console.warn("Running in Demo Mode (Firebase not configured):", e);
            // MOCK AUTH for UI Demonstration
            auth = {
                onAuthStateChanged: (callback) => {
                    // Simulate a logged-in user for the demo
                    callback({ uid: 'demo-user', displayName: 'Demo Guardian' });
                    return () => {};
                },
                signInWithPopup: () => Promise.resolve(),
                signInAnonymously: () => Promise.resolve(),
                signInWithCustomToken: () => Promise.resolve(),
                signOut: () => { window.location.reload(); }, // Reload to reset demo
                currentUser: { uid: 'demo-user', displayName: 'Demo Guardian' }
            };
            db = { firestore: () => {} };
        }

        // --- COMPONENTS ---

        // FIX: Robust Icon component that handles missing Lucide safely
        const Icon = ({ name, className, ...props }) => {
            // Safety check: if Lucide isn't loaded or icon name is wrong
            if (typeof lucide === 'undefined' || !lucide.icons || !lucide.icons[name]) {
                return null; // Render nothing instead of crashing
            }
            
            try {
                const svgHtml = lucide.icons[name].toSvg({
                    class: className || '',
                    ...props
                });
                
                return (
                    <span 
                        dangerouslySetInnerHTML={{ __html: svgHtml }} 
                        style={{ display: 'inline-flex', alignItems: 'center', lineHeight: 0 }}
                    />
                );
            } catch (err) {
                return null;
            }
        };

        const Logo = () => (
            <div className="flex items-center gap-2">
                <div className="relative flex items-center justify-center w-8 h-8 rounded-xl bg-gradient-to-tr from-rose-500 to-orange-500 shadow-lg shadow-rose-500/20">
                    <Icon name="Shield" className="text-white w-5 h-5 relative z-10" />
                </div>
                <span className="text-xl font-bold tracking-tight text-white">Raksha<span className="text-rose-500">X</span></span>
            </div>
        );

        // 1. HOME VIEW
        const HomeView = ({ user, setView }) => {
            const [isSOSActive, setIsSOSActive] = useState(false);
            const [countdown, setCountdown] = useState(5);
            const timerRef = useRef(null);

            const handleSOSClick = () => {
                if (isSOSActive) {
                    setIsSOSActive(false);
                    clearInterval(timerRef.current);
                    setCountdown(5);
                } else {
                    setIsSOSActive(true);
                    timerRef.current = setInterval(() => {
                        setCountdown(prev => {
                            if (prev <= 1) {
                                clearInterval(timerRef.current);
                                // TRIGGER ACTUAL SOS LOGIC HERE
                                alert("SOS ALERT SENT! (Simulation)");
                                setIsSOSActive(false);
                                return 5;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                }
            };

            return (
                <div className="flex flex-col h-full px-5 pb-24 overflow-y-auto">
                    {/* Header Status */}
                    <div className="mt-2 mb-8">
                        <h1 className="text-2xl font-bold text-white mb-1">Hello, {user?.displayName || 'Guardian'}</h1>
                        <div className="flex items-center gap-2 text-emerald-400 bg-emerald-500/10 px-3 py-1.5 rounded-full w-fit border border-emerald-500/20">
                            <span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                            <span className="text-xs font-semibold tracking-wide">SYSTEM ACTIVE</span>
                        </div>
                    </div>

                    {/* SOS Button Area */}
                    <div className="flex-1 flex flex-col items-center justify-center min-h-[300px]">
                        <button 
                            onClick={handleSOSClick}
                            className={`relative w-48 h-48 rounded-full flex items-center justify-center transition-all duration-300 ${isSOSActive ? 'bg-white scale-110' : 'bg-gradient-to-b from-rose-500 to-rose-600 shadow-2xl shadow-rose-500/40'}`}
                        >
                            {isSOSActive && <div className="absolute inset-0 rounded-full pulse-ring bg-rose-500/20"></div>}
                            <div className="flex flex-col items-center z-10">
                                {isSOSActive ? (
                                    <span className="text-6xl font-black text-rose-600 font-mono">{countdown}</span>
                                ) : (
                                    <>
                                        <Icon name="Bell" className="w-16 h-16 text-white mb-2" />
                                        <span className="text-xl font-bold text-white tracking-widest">SOS</span>
                                    </>
                                )}
                            </div>
                        </button>
                        <p className="mt-8 text-slate-400 text-sm font-medium text-center max-w-[200px]">
                            {isSOSActive ? "Tap again to CANCEL" : "Tap immediately for Emergency Assistance"}
                        </p>
                    </div>

                    {/* Quick Actions Grid */}
                    <div className="grid grid-cols-2 gap-3 mt-auto">
                        <button onClick={() => setView('map')} className="glass-panel p-4 rounded-2xl flex flex-col items-center justify-center gap-2 active:scale-95 transition-transform border-l-4 border-l-blue-500">
                            <div className="p-3 bg-blue-500/20 rounded-full text-blue-400">
                                <Icon name="MapPin" className="w-6 h-6" />
                            </div>
                            <span className="text-sm font-semibold text-slate-200">Safe Map</span>
                        </button>
                        <button onClick={() => setView('protocol')} className="glass-panel p-4 rounded-2xl flex flex-col items-center justify-center gap-2 active:scale-95 transition-transform border-l-4 border-l-amber-500">
                            <div className="p-3 bg-amber-500/20 rounded-full text-amber-400">
                                <Icon name="BookOpen" className="w-6 h-6" />
                            </div>
                            <span className="text-sm font-semibold text-slate-200">Protocols</span>
                        </button>
                    </div>
                </div>
            );
        };

        // 2. MAP VIEW (Placeholder)
        const MapView = ({ onBack }) => {
            return (
                <div className="h-full flex flex-col bg-slate-900">
                    <div className="p-5 flex items-center gap-4 glass-panel z-10">
                        <button onClick={onBack} className="p-2 bg-slate-800 rounded-full"><Icon name="ArrowLeft" className="w-5 h-5 text-white" /></button>
                        <h2 className="text-lg font-bold text-white">Live Tracking</h2>
                    </div>
                    <div className="flex-1 flex items-center justify-center bg-slate-800 relative overflow-hidden">
                        <div className="absolute inset-0 opacity-20" style={{backgroundImage: 'radial-gradient(circle at 50% 50%, #334155 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>
                        <div className="text-center p-8">
                            <Icon name="Map" className="w-16 h-16 text-slate-600 mx-auto mb-4" />
                            <p className="text-slate-400">Map Module Loading...</p>
                            <p className="text-xs text-slate-600 mt-2">API Key Required for G-Maps</p>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. PROTOCOL VIEW
        const ProtocolView = ({ onBack }) => {
            const [selectedId, setSelectedId] = useState(null);

            const protocols = [
                { id: 'general', title: 'General Safety', icon: 'Shield', color: 'emerald', steps: ['Stay aware of surroundings', 'Keep emergency contacts ready', 'Trust your instincts', 'Share location with family'] },
                { id: 'harassment', title: 'Harassment', icon: 'AlertTriangle', color: 'orange', steps: ['Move to a crowded area', 'Call 100 or Emergency SOS', 'Do not engage the harasser', 'Record evidence if safe'] },
                { id: 'medical', title: 'Medical Emergency', icon: 'Heart', color: 'rose', steps: ['Check for breathing/pulse', 'Call Ambulance immediately', 'Perform CPR if trained', 'Do not move patient unless necessary'] },
                { id: 'fire', title: 'Fire Safety', icon: 'Flame', color: 'orange', steps: ['Stay low to the ground', 'Check doors for heat', 'Use stairs, not elevators', 'Stop, Drop, and Roll if clothes catch fire'] },
                // ADDED FEATURE 2: New Safety Protocols
                { id: 'earthquake', title: 'Earthquake', icon: 'Activity', color: 'amber', steps: ['Drop, Cover, and Hold On', 'Stay away from windows/glass', 'Stay indoors until shaking stops', 'If outside, find open spot away from buildings'] },
                { id: 'accident', title: 'Road Accident', icon: 'AlertCircle', color: 'red', steps: ['Ensure your own safety first', 'Call Emergency Services', 'Do not move injured persons', 'Turn on hazard lights/set perimeter'] }
            ];

            return (
                <div className="h-full flex flex-col px-5 pb-10 overflow-y-auto">
                     <div className="flex items-center gap-4 py-5 mb-2 sticky top-0 bg-[#020617]/90 backdrop-blur-md z-10">
                        <button onClick={onBack} className="p-2 bg-slate-800 rounded-full active:scale-90 transition-transform"><Icon name="ArrowLeft" className="w-5 h-5 text-white" /></button>
                        <h2 className="text-xl font-bold text-white">Safety Protocols</h2>
                    </div>

                    <div className="grid gap-3">
                        {protocols.map(p => (
                            <div key={p.id} className="glass-panel rounded-2xl overflow-hidden">
                                <button 
                                    onClick={() => setSelectedId(selectedId === p.id ? null : p.id)}
                                    className="w-full p-4 flex items-center justify-between text-left"
                                >
                                    <div className="flex items-center gap-3">
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center bg-${p.color}-500/20 text-${p.color}-400`}>
                                            <Icon name={p.icon} className="w-5 h-5" />
                                        </div>
                                        <span className="font-semibold text-slate-200">{p.title}</span>
                                    </div>
                                    <Icon name={selectedId === p.id ? "ChevronUp" : "ChevronDown"} className="w-5 h-5 text-slate-500" />
                                </button>
                                {selectedId === p.id && (
                                    <div className="px-4 pb-4 pt-0">
                                        <div className="h-px w-full bg-slate-700/50 mb-3"></div>
                                        <ul className="space-y-2">
                                            {p.steps.map((step, idx) => (
                                                <li key={idx} className="flex gap-3 text-sm text-slate-300">
                                                    <span className={`text-${p.color}-400 font-bold`}>{idx + 1}.</span>
                                                    <span>{step}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // 4. LEGAL VIEW (Placeholder)
        const LegalView = ({ onBack }) => (
            <div className="h-full p-5 overflow-y-auto">
                <button onClick={onBack} className="mb-6 p-2 bg-slate-800 rounded-full"><Icon name="ArrowLeft" className="w-5 h-5 text-white" /></button>
                <h1 className="text-2xl font-bold text-white mb-4">Legal & Privacy</h1>
                <div className="text-slate-400 space-y-4 text-sm">
                    <p>This is a demonstration build of Raksha X.</p>
                    <p>Emergency services features are simulated.</p>
                </div>
            </div>
        );

        // ADDITIVE FIX: Quick Exit Component (Feature 4)
        const QuickExitButton = () => {
            const handleExit = () => {
                // Instantly replace current URL with Google, removing app from history
                window.location.replace("https://www.google.com");
            };

            return (
                <button 
                    onClick={handleExit}
                    className="absolute bottom-6 right-6 z-50 bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 px-4 rounded-full shadow-lg shadow-rose-900/50 flex items-center gap-2 transition-transform active:scale-95 border border-rose-400/30"
                    aria-label="Quick Exit to Google"
                >
                    <Icon name="LogOut" className="w-5 h-5" />
                    <span className="text-sm tracking-wide">EXIT</span>
                </button>
            );
        };

        // --- MAIN APP SHELL ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('home'); // home, map, protocol, legal
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [iconsLoaded, setIconsLoaded] = useState(false);

            // Force-refresh to catch icons once Lucide loads
            useEffect(() => {
                const checkLucide = setInterval(() => {
                    if (typeof lucide !== 'undefined') {
                        setIconsLoaded(true);
                        clearInterval(checkLucide);
                    }
                }, 100);
                setTimeout(() => clearInterval(checkLucide), 3000);
                return () => clearInterval(checkLucide);
            }, []);

            // Auth Logic (Safe Mode)
            useEffect(() => {
                // We don't need detailed initAuth here because 'auth' is already
                // safely initialized (either real or mock) at the top level.
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    if (u) {
                        setUser(u);
                    }
                });
                return () => unsubscribe();
            }, []);

            const signInGoogle = () => {
                // Not used in current demo flow but kept for structure
                // auth.signInWithPopup(...);
            };

            const signOut = () => auth.signOut();

            const installApp = () => {
                // PWA Install Prompt Logic (Browser dependent)
                alert("To install: Tap Share -> Add to Home Screen");
            };

            return (
                <div className="h-screen w-full flex flex-col relative overflow-hidden">
                    {/* Top Navigation */}
                    <nav className="absolute top-0 left-0 right-0 h-16 px-5 flex items-center justify-between z-50 bg-[#020617]/80 backdrop-blur-sm border-b border-white/5">
                        <Logo />
                        {/* ... existing navigation code ... */}
                        <div className="relative">
                            <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className="p-2 rounded-full bg-slate-800/50 hover:bg-slate-700 transition-colors">
                                <Icon name={mobileMenuOpen ? "X" : "Menu"} className="w-6 h-6 text-white" />
                            </button>
                            
                            {/* Dropdown Menu */}
                            {mobileMenuOpen && (
                                <div className="absolute right-0 top-14 w-64 glass-panel rounded-2xl p-2 flex flex-col gap-1 shadow-2xl animate-in fade-in slide-in-from-top-5">
                                    <div className="px-4 py-3 border-b border-white/5 mb-1">
                                        <p className="text-xs text-slate-400 uppercase tracking-wider font-bold">Signed in as</p>
                                        <p className="text-sm text-white font-medium truncate">{user?.displayName || 'Anonymous User'}</p>
                                    </div>
                                    
                                    {[
                                        { id: 'home', label: 'Dashboard', icon: 'Home' },
                                        { id: 'map', label: 'Safe Map', icon: 'MapPin' },
                                        { id: 'protocol', label: 'Safety Protocols', icon: 'BookOpen' },
                                        { id: 'legal', label: 'Legal Info', icon: 'FileText' }
                                    ].map(item => (
                                        <button 
                                            key={item.id}
                                            onClick={() => { setView(item.id); setMobileMenuOpen(false); }}
                                            className={`flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-colors ${view === item.id ? 'bg-rose-500 text-white' : 'text-slate-300 hover:bg-slate-800'}`}
                                        >
                                            <Icon name={item.icon} className="w-4 h-4" />
                                            {item.label}
                                            {view === item.id && <span className="ml-auto w-1.5 h-1.5 bg-white rounded-full"></span>}
                                        </button>
                                    ))}
                                    
                                    <div className="h-px bg-white/10 my-1"></div>
                                    
                                    <button onClick={installApp} className="text-left px-5 py-4 rounded-2xl text-sm font-bold text-emerald-400 hover:bg-emerald-500/10 transition-all flex items-center gap-2">
                                        <Icon name="Download" className="w-4 h-4" /> Install App
                                    </button>
                                    
                                    <button onClick={() => { signOut(); setMobileMenuOpen(false); }} className="text-left px-5 py-4 rounded-2xl text-sm font-bold text-rose-400 hover:bg-rose-500/10 hover:text-rose-300 transition-all flex items-center gap-2">
                                        <Icon name="LogOut" className="w-4 h-4" /> Sign Out
                                    </button>
                                </div>
                            )}
                        </div>
                    </nav>

                    {/* Main Content Area */}
                    <main className="h-full w-full pt-20">
                        {view === 'home' && <HomeView user={user} setView={setView} />}
                        {view === 'map' && <MapView onBack={() => setView('home')} />}
                        {view === 'protocol' && <ProtocolView onBack={() => setView('home')} />}
                        {view === 'legal' && <LegalView onBack={() => setView('home')} />}
                    </main>

                    {/* Feature 4: Quick Exit Button */}
                    <QuickExitButton />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
